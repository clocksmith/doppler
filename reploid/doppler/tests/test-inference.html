<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DOPPLER Inference Test</title>
  <link rel="stylesheet" href="/doppler/rd.css">
  <style>
    /* Test page layout only - all component styling from rd.css */
    body { padding: var(--space-lg); }
    h1 { margin-bottom: var(--space-md); }
    #status { margin-bottom: var(--space-md); }
    #results { display: none; }
    #results.show { display: block; }
    .section { margin-bottom: var(--space-md); }
    .output {
      padding: var(--space-sm);
      border-left: var(--border-md) solid var(--fg);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .stats { display: flex; gap: var(--space-lg); }
    .stat-value { font-size: 18px; font-weight: 600; }
  </style>
</head>
<body>
  <h1 class="type-h1">DOPPLER INFERENCE TEST</h1>
  <div id="status" class="muted type-caption">Initializing...</div>
  <div id="results"></div>

  <script type="module">
    import {
      discoverModels,
      parseRuntimeOverridesFromURL,
      createHttpShardLoader,
      fetchManifest,
      initializeDevice,
      createTestState,
    } from '/doppler/dist/inference/test-harness.js';
    import { createPipeline } from '/doppler/dist/inference/pipeline.js';
    import { getDevice } from '/doppler/dist/gpu/device.js';
    import { getKernelHints } from '/doppler/dist/gpu/kernel-hints.js';

    // Parse query params
    const params = new URLSearchParams(window.location.search);
    const paramModel = params.get('model') || 'gemma-3-1b-it-q4';
    const paramAutorun = params.get('autorun') === '1';
    const runtimeOverrides = parseRuntimeOverridesFromURL(params);

    const BASE_URL = 'http://localhost:8080/doppler/models';

    // Test state for Playwright
    window.testState = createTestState();

    async function run() {
      const MODEL_URL = `${BASE_URL}/${paramModel}`;
      const prompt = 'The color of the sky is';

      console.log('1. Initializing WebGPU...');

      try {
        // 1. Init GPU
        const caps = await initializeDevice();
        const device = getDevice();
        console.log(`[GPU] ${caps.adapterInfo?.device || 'unknown'}, ${caps.hasF16 ? 'f16' : 'f32'}/${caps.hasSubgroups ? 'subgroups' : 'no-subgroups'}, ${(caps.adapterInfo?.memorySize / 1e9 || 0).toFixed(1)}GB`);

        // Log kernel hints
        const hints = getKernelHints();
        if (hints) {
          console.log(`[KernelHints] Set from runtime: ${JSON.stringify(hints)}`);
        }

        // 2. Load manifest
        console.log('2. Loading manifest...');
        const manifest = await fetchManifest(`${MODEL_URL}/manifest.json`);
        console.log(`[Model] ${manifest.architecture || paramModel}, ${manifest.config?.num_hidden_layers} layers`);

        // 3. Create pipeline
        console.log('3. Loading model weights...');
        const loadShard = createHttpShardLoader(MODEL_URL, manifest, (msg) => console.log(`[Loader] ${msg}`));

        const pipeline = await createPipeline(manifest, {
          storage: { loadShard },
          gpu: { device },
          baseUrl: MODEL_URL,
          runtime: {
            debug: runtimeOverrides.debug,
            attentionKernel: runtimeOverrides.attentionKernel || 'auto',
            kernelHints: runtimeOverrides.kernelHints,
          },
        });

        window.testState.loaded = true;
        console.log('[Model] Loaded');

        // 4. Generate - console.log only, no DOM updates
        console.log(`4. Generating from: "${prompt}"`);
        const tokens = [];
        const startTime = performance.now();

        for await (const tokenText of pipeline.generate(prompt, {
          maxTokens: 8,
          temperature: 0,
          useChatTemplate: true,
        })) {
          tokens.push(tokenText);
          console.log(`[Token] ${tokens.length}: "${tokenText}"`);
        }

        const elapsed = performance.now() - startTime;
        const tokPerSec = tokens.length / (elapsed / 1000);
        const output = tokens.join('');

        window.testState.output = output;
        window.testState.tokens = tokens;
        window.testState.done = true;

        console.log(`[Done] ${tokens.length} tokens in ${elapsed.toFixed(0)}ms (${tokPerSec.toFixed(1)} tok/s)`);
        console.log(`[Output] ${output}`);

        // 5. Single DOM update at end
        renderResults({
          model: paramModel,
          prompt,
          output,
          tokens: tokens.length,
          elapsed: elapsed.toFixed(0),
          tokPerSec: tokPerSec.toFixed(1),
          passed: tokens.length > 0,
        });

      } catch (e) {
        console.error(`[Error] ${e.message}`);
        console.error(e.stack);
        window.testState.errors.push(e.message);
        window.testState.done = true;
        document.getElementById('status').textContent = `Error: ${e.message}`;
        document.getElementById('status').classList.add('border-error');
      }
    }

    function renderResults(r) {
      const container = document.getElementById('results');
      container.innerHTML = `
        <div class="section">
          <div class="type-label muted">Model</div>
          <div>${r.model}</div>
        </div>
        <div class="section">
          <div class="type-label muted">Prompt</div>
          <div>${r.prompt}</div>
        </div>
        <div class="section">
          <div class="type-label muted">Output</div>
          <div class="output">${r.output}</div>
        </div>
        <div class="section stats">
          <div class="stat">
            <div class="stat-value">${r.tokens}</div>
            <div class="type-caption muted">tokens</div>
          </div>
          <div class="stat">
            <div class="stat-value">${r.elapsed}ms</div>
            <div class="type-caption muted">total</div>
          </div>
          <div class="stat">
            <div class="stat-value">${r.tokPerSec}</div>
            <div class="type-caption muted">tok/s</div>
          </div>
        </div>
        <div class="section">
          <div class="${r.passed ? 'badge badge-filled' : 'badge border-error muted'}">${r.passed ? 'PASS' : 'FAIL'}</div>
        </div>
      `;
      container.classList.add('show');
      document.getElementById('status').style.display = 'none';
    }

    // Auto-run if requested
    if (paramAutorun) {
      document.getElementById('status').textContent = 'Running...';
      run();
    } else {
      document.getElementById('status').textContent = 'Add ?autorun=1 to URL to run';
    }
  </script>
</body>
</html>
